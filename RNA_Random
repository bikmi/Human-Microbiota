----------------------------------------------------
#文件的传输错误检测以及初步查看测序质量
unzip -n 2.cleandata.zip
for i in RanLib*;cp $i/* All
cd All
md5sum -c MD5_RanLib*.txt
fastqc RanLib*.fq.gz
----------------------------------------------------
#导入文件拼接，质控
qiime tools import --type 'SampleData[PairedEndSequencesWithQuality]' --input-path manifest.txt --output-path paired-end-demux.qza --input-format PairedEndFastqManifestPhred33V2
qiime demux summarize --i-data paired-end-demux.qza --o-visualization paired-end-demux.qzv
qiime vsearch join-pairs --i-demultiplexed-seqs paired-end-demux.qza --o-joined-sequences paired-end-demux-joined.qza --p-threads 8 --p-truncqual 20 --p-maxns 0 --p-minovlen 20 --p-maxdiffs 0
qiime demux summarize --i-data paired-end-demux-joined.qza --o-visualization paired-end-demux-joined.qzv
qiime quality-filter q-score-joined --i-demux paired-end-demux-joined.qza --o-filtered-sequences paired-end-demux-joined-filtered.qza --o-filter-stats paired-end-demux-joined-filtered-stats.qza --p-min-quality 20
qiime demux summarize --i-data paired-end-demux-joined-filtered.qza --o-visualization paired-end-demux-joined-filtered.qzv
-----------------------------------------------
#人体微生物的转录本中挑选除细菌的SSU rRNA
unzip -n paired-end-demux-joined-filtered.qza 
gzip -d -k * 
for i in *fastq;metaxa2 -i $i -o $i.metaxa --cpu 30 
/home/server/sina-1.6.1-linux/sina -i Bacteria.fasta --db /home/disk3/zhangruyi/database/SILVA_138/SILVA_138_SSURef_NR99_05_01_20_opt.arb -p 30 -o Bacteria.sinaalign.fasta --fasta-write-dna
------------------------------------------------
#挑选V1-V2区的序列
mothur > pcr.seqs(fasta=Bacteria.sinaalign.fasta,start=1006, end=6421, processors=30)
summary.seqs(fasta=Bacteria.sinaalign.fasta)

                Start   End     NBases  Ambigs  Polymer NumSeqs
Minimum:        1044    1125    1       0       1       1
2.5%-tile:      1044    5462    146     0       3       33254
25%-tile:       1046    6217    290     0       5       332537
Median:         1046    6332    301     0       5       665073
75%-tile:       1048    6332    307     0       6       997609
97.5%-tile:     3616    6332    320     0       6       1296891
Maximum:        6332    6332    358     0       18      1330144
Mean:   1182.01 6233.16 289.247 0       5.0995
# of Seqs:      1330144

Output File Names:
Bacteria.sinaalign.pcr.summary

It took 606 secs to summarize 1330144 sequences.
mothur > screen.seqs(fasta=Bacteria.sinaalign.pcr.fasta,start=1048, end=6217,minlength=250,processors=30)
#获得V1-V2区序列的名字
for i in *.bacteria.fasta; seqkit seq $i -n -i > $i.ID 
mkdir V1V2 
cat *.fastq > all.fastq 
sed 's/_/:/g' Bacteria.sinaalign.pcr.good.fasta > Bacteria.sinaalign.pcr.good.fasta.1
parallel -j 30 seqkit grep -f {} Bacteria.sinaalign.pcr.good.fasta.1 -o {}.V.fasta ::: *bacteria.fasta.ID
for i in *V.fasta;seqkit seq $i -n -i > $i.ID 
cp *ID.V.fasta.ID V1V2
cd V1V2
cp ../*ID.V.fasta.degap.fasta . 
rename 's/.fastq.metaxa.bacteria.fasta.ID.V.fasta.degap//' *
for i in *fasta;perl fa2fq.pl $i > $i.fastq
rename 's/.fasta.fastq/.fastq/' * 
qiime tools import --input-path manifest.txt --output-path joined-demux.qza --type 'SampleData[JoinedSequencesWithQuality]' --input-format SingleEndFastqManifestPhred33V2
qiime demux summarize --i-data joined-demux.qza --o-visualization joined-demux.qzv
qiime deblur denoise-16S --i-demultiplexed-seqs joined-demux.qza --p-trim-length 250 --p-sample-stats --o-representative-sequences rep-seqs.qza --o-table table.qza --o-stats deblur-stats.qza
qiime feature-table summarize --i-table table.qza --o-visualization table.qzv
qiime feature-classifier classify-consensus-vsearch --i-query rep-seqs.qza --i-reference-reads /home/disk2/DATABAE/QIIME2/silva-138-99-seqs.qza --i-reference-taxonomy /home/disk2/DATABAE/QIIME2/silva-138-99-tax.qza --p-threads 30 --o-classification vsearch-tax.qza
qiime metadata tabulate --m-input-file vsearch-tax.qza --o-visualization vsearch-tax.qzv
qiime deblur visualize-stats --i-deblur-stats deblur-stats.qza --o-visualization deblur-stats.qzv
qiime phylogeny align-to-tree-mafft-fasttree --i-sequences rep-seqs.qza --o-alignment aligned-rep-seqs.qza --o-masked-alignment masked-aligned-rep-seqs.qza --o-tree unrooted-tree.qza --o-rooted-tree rooted-tree.qza
qiime diversity core-metrics-phylogenetic --i-phylogeny rooted-tree.qza --i-table table.qza --p-sampling-depth 3000 --m-metadata-file metadata.txt --output-dir core-metrics-results
qiime diversity alpha-group-significance --i-alpha-diversity core-metrics-results/faith_pd_vector.qza --m-metadata-file metadata.txt --o-visualization core-metrics-results/faith-pd-group-significance.qzv
qiime diversity alpha-group-significance --i-alpha-diversity core-metrics-results/evenness_vector.qza --m-metadata-file metadata.txt --o-visualization core-metrics-results/evenness-group-significance.qzv
qiime diversity beta-group-significance --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza --m-metadata-file metadata.txt --m-metadata-column treatment-group --o-visualization core-metrics-results/unweighted-unifrac-body-site-significance.qzv --p-pairwise
qiime emperor plot --i-pcoa core-metrics-results/unweighted_unifrac_pcoa_results.qza --m-metadata-file metadata.txt --o-visualization core-metrics-results/unweighted-unifrac-emperor-days-since-experiment-start.qzv
qiime diversity alpha-rarefaction --i-table table.qza  --i-phylogeny rooted-tree.qza  --p-max-depth 10000 --m-metadata-file metadata.txt --o-visualization alpha-rarefaction.qzv
qiime taxa barplot --i-table table.qza --i-taxonomy vsearch-tax.qza --m-metadata-file metadata.txt --o-visualization taxa-bar-plots.qzv
qiime tools export --input-path table.qza --output-path exported-feature-table
qiime tools export --input-path vsearch-tax.qza  --output-path exported-feature-table
cd exported-feature-table
biom convert -i feature-table.biom -o table.tsv --to-tsv
sed -i -e '1 s/Feature ID/#OTUID/' -e '1 s/Taxon/taxonomy/' -e '1 s/Consensus/confidence/' taxonomy.tsv
biom add-metadata -i feature-table.biom -o table-with-taxonomy.biom --observation-metadata-fp taxonomy.tsv --sc-separated taxonomy
biom convert -i table-with-taxonomy.biom -o OTU_Table.txt --to-tsv --header-key taxonomy
cd ..
qiime taxa collapse --i-table table.qza --i-taxonomy vsearch-tax.qza --p-level 7 --o-collapsed-table table-l7.qza 
qiime tools export --input-path table-l7.qza --output-path exported-l7-table 
qiime tools export --input-path vsearch-tax.qza  --output-path exported-l7-table 
cd exported-l7-table
biom convert -i feature-table.biom -o table.tsv --to-tsv
sed -i -e '1 s/Feature ID/#OTUID/' -e '1 s/Taxon/taxonomy/' -e '1 s/Consensus/confidence/' taxonomy.tsv
biom add-metadata -i feature-table.biom -o table-with-taxonomy.biom --observation-metadata-fp taxonomy.tsv --sc-separated taxonomy
biom convert -i table-with-taxonomy.biom -o OTU_Table.txt --to-tsv --header-key taxonomy




for i in *V.fasta.ID;seqkit 
cp *ID /home/disk2/zry/SkinMicrobiota/RNA/Random/MERGE
cd /home/disk2/zry/SkinMicrobiota/RNA/Random/MERGE
gzip -k -d *fq.gz
cat *_1.clean.fq >all_1.fastq 
cat *_2.clean.fq >all_2.fastq
#获得V1-V2区序列对应的原始序列
parallel -j 30 seqkit grep -f {} all_1.fq -o {}_1.fq ::: *ID
parallel -j 30 seqkit grep -f {} all_2.fq -o {}_2.fq ::: *ID
mkdir Bacteria
cp *V.fasta.ID_2.fq Bacteria
cp *V.fasta.ID_1.fq Bacteria
cd Bacteria
rename 's/.fastq.metaxa.bacteria.fasta.ID.V.fasta.ID//' * 

之后的分析参考QIIME2和DADA2的分析




